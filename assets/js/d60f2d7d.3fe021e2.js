"use strict";(self.webpackChunkmarkdown_website=self.webpackChunkmarkdown_website||[]).push([[836],{23491:(e,s,i)=>{i.r(s),i.d(s,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>t,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"clients/puignau-bcn/3394/fase 1/PNAU/Metodes a revisar","title":"Metodes a revisar","description":"pPersSyncPrecios vs pPersSyncPrecios_Delegacion","source":"@site/docs/clients/puignau-bcn/3394/fase 1/PNAU/Metodes a revisar.md","sourceDirName":"clients/puignau-bcn/3394/fase 1/PNAU","slug":"/clients/puignau-bcn/3394/fase 1/PNAU/Metodes a revisar","permalink":"/docs/clients/puignau-bcn/3394/fase 1/PNAU/Metodes a revisar","draft":false,"unlisted":false,"editUrl":"https://github.com/estmi/nowtech-docs/tree/master/docs/clients/puignau-bcn/3394/fase 1/PNAU/Metodes a revisar.md","tags":[],"version":"current","frontMatter":{},"sidebar":"clientsSidebar","previous":{"title":"Control Peix","permalink":"/docs/clients/puignau-bcn/3394/fase 1/PNAU/ControlPeix.exe"},"next":{"title":"PAssignarPreusAlbarans","permalink":"/docs/clients/puignau-bcn/3394/fase 1/PNAU/PAssignarPreusAlbarans.exe"}}');var a=i(74848),r=i(28453);const t={},o="Metodes a revisar",l={},c=[{value:"pPers_Sync_Precios vs pPers_Sync_Precios_Delegacion",id:"ppers_sync_precios-vs-ppers_sync_precios_delegacion",level:2},{value:"SQL Code",id:"sql-code",level:3},{value:"Buidar taules (create methods)",id:"buidar-taules-create-methods",level:2},{value:"SQL Code",id:"sql-code-1",level:3},{value:"pPers_Actualitzar_Preus_Article vs pPers_Actualitzar_Preus_Article_NOU",id:"ppers_actualitzar_preus_article-vs-ppers_actualitzar_preus_article_nou",level:2},{value:"pPers_Inicialitzar_Preus_A0_Empresa vs pPers_Inicialitzar_Preus_A0",id:"ppers_inicialitzar_preus_a0_empresa-vs-ppers_inicialitzar_preus_a0",level:2},{value:"vpers_articles vs fpers_articles",id:"vpers_articles-vs-fpers_articles",level:2}];function d(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.header,{children:(0,a.jsx)(s.h1,{id:"metodes-a-revisar",children:"Metodes a revisar"})}),"\n",(0,a.jsx)(s.h2,{id:"ppers_sync_precios-vs-ppers_sync_precios_delegacion",children:"pPers_Sync_Precios vs pPers_Sync_Precios_Delegacion"}),"\n",(0,a.jsx)(s.p,{children:"Taules promociones, promociones_detalle, listas_precios_cli y listas_precios_cli_art.\npers_tarifas_venta y pers_excepciones_venta."}),"\n",(0,a.jsx)(s.h3,{id:"sql-code",children:"SQL Code"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE OR ALTER PROCEDURE [dbo].[pPers_Sync_Precios_Delegacion](@IdDelegacion T_ID_Delegacion)\nAS\nBEGIN TRY\n\nbegin tran\n\ndeclare @IdLista int\ndeclare @Revision varchar(10)\ndeclare @IdEmpresa T_Id_Empresa\n\n-- Recuperem empresa de la delegaci\xf3\nSelect @IdEmpresa = IdEmpresa from Delegaciones Where IdDelegacion = @IdDelegacion\n\n/*\n 1. TRACTAMENT DE LES LLISTES DE PREUS\n\n S'actualitza les llistes de preus d'articles amb els articles de la taula Pers_Tarifas_Venta.\n Primerament es fa una c\xf2pia de les llistes existents a l'hist\xf2ric.\n Tot seguit s'eliminem UNICAMENT els preus passats a Pers_Tarifas_Venta i s'insereixen a Listas_Precios_Cli_Art\n Han d'existir les 5 Llistes de preus.\n*/ \n\n-- Proc\xe9s de c\xf2pia hist\xf2ric dels preus de cada llista.\nSelect @IdLista = null, @Revision = null\nSelect @IdLista = Pers_IdListaPrecioCliT1 from Conf_Empresas Where IdEmpresa = @IdEmpresa\nSelect @Revision=Revision from Listas_Precios_Cli where IdLista=@IdLista\nif (@IdLista is not null) and (@Revision is not null)\nbegin\n  Update Listas_Precios_Cli set Cerrado=1 where IdLista=@IdLista\n  Exec PListas_Precios_Cli_a_Hist @IdLista, @Revision\nend\n\nSelect @IdLista = null, @Revision = null\nSelect @IdLista = Pers_IdListaPrecioCliT2 from Conf_Empresas Where IdEmpresa = @IdEmpresa\nSelect @Revision=Revision from Listas_Precios_Cli where IdLista=@IdLista\nif (@IdLista is not null) and (@Revision is not null)\nbegin\n  Update Listas_Precios_Cli set Cerrado=1 where IdLista=@IdLista\n  Exec PListas_Precios_Cli_a_Hist @IdLista, @Revision\nend\n\nSelect @IdLista = null, @Revision = null\nSelect @IdLista = Pers_IdListaPrecioCliT3 from Conf_Empresas Where IdEmpresa = @IdEmpresa\nSelect @Revision=Revision from Listas_Precios_Cli where IdLista=@IdLista\nif (@IdLista is not null) and (@Revision is not null)\nbegin\n  Update Listas_Precios_Cli set Cerrado=1 where IdLista=@IdLista\n  Exec PListas_Precios_Cli_a_Hist @IdLista, @Revision\nend\n\nSelect @IdLista = null, @Revision = null\nSelect @IdLista = Pers_IdListaPrecioCliT4 from Conf_Empresas Where IdEmpresa = @IdEmpresa\nSelect @Revision=Revision from Listas_Precios_Cli where IdLista=@IdLista\nif (@IdLista is not null) and (@Revision is not null)\nbegin\n  Update Listas_Precios_Cli set Cerrado=1 where IdLista=@IdLista\n  Exec PListas_Precios_Cli_a_Hist @IdLista, @Revision\nend\n\nSelect @IdLista = null, @Revision = null\nSelect @IdLista = Pers_IdListaPrecioCliT5 from Conf_Empresas Where IdEmpresa = @IdEmpresa\nSelect @Revision=Revision from Listas_Precios_Cli where IdLista=@IdLista\nif (@IdLista is not null) and (@Revision is not null)\nbegin\n  Update Listas_Precios_Cli set Cerrado=1 where IdLista=@IdLista\n  Exec PListas_Precios_Cli_a_Hist @IdLista, @Revision\nend\n\n-- Primer eliminem de la llista els articles de cada empresa i llista que ens venen a Pers_Tarifas_Venta\ndelete Listas_Precios_Cli_Art\nFrom Listas_Precios_Cli_Art as L\nInner Join Pers_Tarifas_Venta as P on P.IdEmpresa = @IdEmpresa and P.IdLista = L.IdLista and P.IdArticulo = L.IdArticulo\n\n-- Insertem els preus dels articles a cada llista\ninsert into Listas_Precios_Cli_Art(IdLista, IdArticulo, Precio, Descuento1, DesdeFecha)\nselect idlista, IdArticulo, Precio, Descuento, FechaDesde\nfrom pers_tarifas_venta \nWhere IdEmpresa = @IdEmpresa\n\n/*\n 2. TRACTAMENT DE LES EXCEPCIONS DE PREUS\n\n Es crea les Promocions i Promocions Detalls per cada excepci\xf3 passada a Pers_Excepciones_Ventas\n Primerament es crea la cap\xe7alera de la Promoci\xf3 assignant el client a Conf_Promociones\n*/\n\n-- Creem una nova promoci\xf3 pels clients diferents trobats.\nDeclare @temp table (IdCliente varchar(15))\ninsert into @temp \nselect IdCliente From Pers_Excepciones_Venta Where IdDelegacion = @IdDelegacion group by IdCliente order by IdCliente\n\n-- Creem les promocions dels clients.\ninsert into Promociones(IdPromocion, Descrip, IdEmpresa, IdDelegacion)\nselect (select coalesce(max(IdPromocion),0) from Promociones)+ROW_NUMBER() over (order by cp.P_Idcliente), pev.IdCliente, @IdEmpresa, @IdDelegacion\nfrom @temp pev\nleft join Conf_Promociones cp on pev.IdCliente=cp.P_IdCliente\nleft join Clientes_Datos as C on C.IdCliente = pev.IdCliente\nLeft Join Delegaciones as D on D.IdDelegacion = C.IdDelegacion\nwhere cp.IdPromocion is null\n\n-- Guardem el client dins configurable per tal de poder-lo cercar.\nupdate cp set cp.P_IdCliente=cd.IdCliente\nfrom Promociones p\ninner join Clientes_Datos cd on p.Descrip=cd.IdCliente\ninner join Conf_Promociones cp on p.IdPromocion=cp.IdPromocion\n\n-- Guardem el nom del client dins la descripci\xf3 de la promoci\xf3 per poder-lo cercar.\nupdate p set p.Descrip=concat('Cliente ', p.Descrip)\nfrom Promociones p\ninner join Clientes_Datos cd on p.Descrip=cd.IdCliente\n\n-- Inserim les excepcions a afegir a Promociones Detalles\nselect cp.IdPromocion, \nIsNull((Select Max(L.IdLinea) From Promociones_Detalles as L Where L.IdPromocion = cp.IdPromocion), 0) + ROW_NUMBER() over (partition by cp.idpromocion order by cp.idpromocion) as IdLinea, pe.IdFamilia, pe.IdArticulo,\ncase when pe.DescuentoTarifa is not null then 7\n\twhen pe.PorcCoste is not null then 9\n\twhen pe.IncrementoTarifa is not null then 8\n\telse 6 end as IdTipo,\ncase when pe.DescuentoTarifa is not null then pe.DescuentoTarifa\n\twhen pe.PorcCoste is not null then pe.PorcCoste\n\twhen pe.IncrementoTarifa is not null then pe.IncrementoTarifa\n\telse pe.Precio end as ValorPromocion,\npe.FechaDesde, pe.FechaHasta, pe.Activo, pe.IdEmpleado, pe.IdEmpleadoValida, pe.Motivo, pe.promocion, pe.IdLista\ninto #Temp\nfrom Pers_Excepciones_Venta pe\ninner join Conf_Promociones cp on pe.IdCliente=cp.P_IdCliente\nWhere pe.IdDelegacion = @IdDelegacion\n\n-- Eliminem primer les excepcions de Promociones Detalles que tenim a la taula Pers_Excepciones_Venta i que no siguin OFERTA.\nDelete Promociones_Detalles\nFrom Promociones_Detalles as D\nLeft Join Conf_Promociones as CP on CP.IdPromocion = D.IdPromocion\nInner Join Pers_Excepciones_Venta as E on IsNull(E.IdCliente, '') = IsNull(CP.P_IdCliente, '') and IsNull(E.IdFamilia, -1) = IsNull(D.IdFamilia, -1) and IsNull(E.IdArticulo, '') = IsNull(D.IdArticulo, '')\nWhere IsNull(E.Promocion, 0) = 0\nand E.IdDelegacion = @IdDelegacion\n\n-- Inserim l'excepci\xf3.\ninsert into Promociones_Detalles(IdPromocion,IdLinea,IdFamilia,IdArticulo,IdTipo,ValorPromocion,FechaIni,FechaFin)\nselect IdPromocion,IdLinea,IdFamilia,IdArticulo,IdTipo,ValorPromocion,FechaDesde,FechaHasta\nfrom #Temp\n\n-- Posem la l\xednia d'excepci\xf3 com a activa\nupdate cpd set cpd.P_Activa=t.Activo, cpd.P_IdEmpSol=t.IdEmpleado, cpd.P_IdEmpVal=t.IdEmpleadoValida, cpd.P_IdLista=t.IdLista, cpd.P_Motivo=t.Motivo, cpd.P_Oferta=t.promocion\nfrom Promociones_Detalles pd\ninner join #Temp t on pd.IdPromocion=t.IdPromocion and pd.IdLinea=t.IdLinea\ninner join Conf_Promociones_Detalles cpd on pd.IdPromocion=cpd.IdPromocion and pd.IdLinea=cpd.IdLinea\n\ncommit tran\n\t\t\n\tRETURN -1\n\t\nEND TRY\nBEGIN CATCH\n\tIF @@TRANCOUNT >0 BEGIN\n\t\tROLLBACK TRAN\n\tEND\n\tDECLARE @CatchError NVARCHAR(MAX)\n\tSET @CatchError=dbo.funImprimeError(ERROR_MESSAGE(),ERROR_NUMBER(),ERROR_PROCEDURE(),@@PROCID ,ERROR_LINE())\n\tRAISERROR(@CatchError,12,1)\n\tRETURN 0\nEND CATCH\nGO\n"})}),"\n",(0,a.jsx)(s.h2,{id:"buidar-taules-create-methods",children:"Buidar taules (create methods)"}),"\n",(0,a.jsx)(s.h3,{id:"sql-code-1",children:"SQL Code"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE OR ALTER PROCEDURE [dbo].[pPers_BuidarTaulaExcepcions] \n\t@IdDelegacion T_ID_Delegacion\nAS\nBEGIN\n  Delete From Pers_Excepciones_Venta Where IdDelegacion = @IdDelegacion\nEND\n"})}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE OR ALTER PROCEDURE [dbo].[pPers_BuidarTaulaPreus] \n\t@IdEmpresa T_ID_Empresa\nAS\nBEGIN\n  Delete From Pers_Tarifas_Venta Where IdEmpresa = @IdEmpresa\nEND\n"})}),"\n",(0,a.jsx)(s.h2,{id:"ppers_actualitzar_preus_article-vs-ppers_actualitzar_preus_article_nou",children:"pPers_Actualitzar_Preus_Article vs pPers_Actualitzar_Preus_Article_NOU"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE PROCEDURE [dbo].[pPers_Actualitzar_Preus_Article_Nou]\n@IdArticulo T_ID_Articulo,\n@CanviarPreuCost bit,\n@PCost numeric(18, 2), \n@PV1 numeric(18, 2), \n@PV2 numeric(18, 2), \n@PV3 numeric(18, 2), \n@PV4 numeric(18, 2), \n@PV5 numeric(18, 2),\n@CanviPreuCaixa bit,\n@PreuCaixa numeric(18,2),\n@IdEmpresa int = 0 -- Per defecte 0, Empresa Puignau\nAS\nBEGIN\n    -- Recuperem les 5 llistes de preus segons l'empresa.\n\tDeclare @IdLista1 T_ID_Lista, @IdLista2 T_ID_Lista, @IdLista3 T_ID_Lista,  @IdLista4 T_ID_Lista, @IdLista5 T_ID_Lista \n\n\tSelect @IdLista1 = Pers_IdListaPrecioCliT1, @IdLista2 = Pers_IdListaPrecioCliT2, @IdLista3 = Pers_IdListaPrecioCliT3, \n\t       @IdLista4 = Pers_IdListaPrecioCliT4, @IdLista5 = Pers_IdListaPrecioCliT5 From Conf_Empresas where IdEmpresa = @IdEmpresa\n\n    -- Si l'article ja existeix dins la taula Pers_Tarifas_Venta, primer l'eliminem\n    if (Select count(*) From Pers_Tarifas_Venta Where IdArticulo = @IdArticulo) > 0\n\t   Delete From Pers_Tarifas_Venta Where IdArticulo = @IdArticulo and IdEmpresa = @IdEmpresa\n\n    -- Actualitzar els 5 preus de venda de l'article. Cada preu correspon al preu del client a la llista de preus\n\tif (Select Count(*) From Articulos as A Where A.IdArticulo = @IdArticulo and (A.IdEmpresa = -1 or A.IdEmpresa = @IdEmpresa)) > 0\n\tbegin\n   \t  Insert Into Pers_Tarifas_Venta(IdLista, IdArticulo, Precio, Descuento, FechaDesde) \n\t  Values (@IdLista1, @IdArticulo, @PV1, 0, '1-1-2000'), (@IdLista2, @IdArticulo, @PV2, 0, '1-1-2000'), (@IdLista3, @IdArticulo, @PV3, 0, '1-1-2000'), \n\t\t     (@IdLista4, @IdArticulo, @PV4, 0, '1-1-2000'), (@IdLista5, @IdArticulo, @PV5, 0, '1-1-2000')\n\tend\n\n\n\t-- Canviem el preu de caixa\n\tIf(@CanviPreuCaixa) = 1\n\tbegin\n\t\tUPDATE Conf_Articulos set P_PreuCaixa = @PreuCaixa where IdArticulo = @IdArticulo\n\tend\n\n\t-- Si ens han demanat canviar el preu de cost de l'article cal actualitzar a la taula Pers_Costes_Manuales.\n\tIF(@CanviarPreuCost) = 1\n\tbegin\n\t\tif exists (Select 1 From Pers_Costes_Manuales as PCM Where PCM.IdArticulo = @IdArticulo and PCM.IdEmpresa = @IdEmpresa)\n\t\tbegin\n\t\t  Update Pers_Costes_Manuales \n\t\t  Set Coste = @PCost, FechaDesde = '1-1-2000', FechaHasta = '31-12-2990'\n\t\t  From Pers_Costes_Manuales as PCM\n\t\t  Where PCM.IdArticulo = @IdArticulo and PCM.IdEmpresa = @IdEmpresa\n\t\tend\n\t\telse\n\t\tbegin\n\t\t  Insert into Pers_Costes_Manuales (IdArticulo, Coste, FechaDesde, FechaHasta, IdEmpresa) Values (@IdArticulo, @PCost, '1-1-2000', '31-12-2990', @IdEmpresa)\n\t\tend\n\tend\nRETURN -1\nEND\n"})}),"\n",(0,a.jsx)(s.h2,{id:"ppers_inicialitzar_preus_a0_empresa-vs-ppers_inicialitzar_preus_a0",children:"pPers_Inicialitzar_Preus_A0_Empresa vs pPers_Inicialitzar_Preus_A0"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE PROCEDURE [dbo].[pPers_Inicialitzar_Preus_A0_Empresa]\n@IdEmpresa T_Id_Empresa = 0\nAS\nBEGIN\n\t-- Obtenim llistes de treball\n\tDeclare @IdLista1 T_ID_Lista, @IdLista2 T_ID_Lista, @IdLista3 T_ID_Lista,  @IdLista4 T_ID_Lista, @IdLista5 T_ID_Lista \n\n\tSelect @IdLista1 = Pers_IdListaPrecioCliT1, @IdLista2 = Pers_IdListaPrecioCliT2, @IdLista3 = Pers_IdListaPrecioCliT3, \n\t       @IdLista4 = Pers_IdListaPrecioCliT4, @IdLista5 = Pers_IdListaPrecioCliT5 From Conf_Empresas where IdEmpresa = @IdEmpresa\n\n    -- Eliminem les definicions dels articles de la empresa de treball\n\tDELETE FROM Pers_Tarifas_Venta where IdEmpresa = @IdEmpresa\n\n    -- Inserim preus a 0 per cada article i llista\n    INSERT INTO Pers_Tarifas_Venta (IdLista, IdArticulo, Precio, Descuento, FechaDesde)\n    SELECT IdLista, Article as IdArticulo, 0 as Precio, 0 as Descuento, GETDATE() as FechaDesde \n    FROM vPers_Articles\n    CROSS JOIN (SELECT @IdLista1 as IdLista UNION ALL\n                SELECT @IdLista2 UNION ALL\n                SELECT @IdLista3 UNION ALL\n                SELECT @IdLista4 UNION ALL\n                SELECT @IdLista5) AS Lista\n    WHERE Familia IN ('PF', 'PFA', 'ECO') \n      AND DataBaixa IS NULL and (Empresa = -1 or Empresa = @IdEmpresa)\n\n    RETURN -1;\nEND\n"})}),"\n",(0,a.jsx)(s.h2,{id:"vpers_articles-vs-fpers_articles",children:"vpers_articles vs fpers_articles"}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql"})})]})}function p(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,a.jsx)(s,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,s,i)=>{i.d(s,{R:()=>t,x:()=>o});var n=i(96540);const a={},r=n.createContext(a);function t(e){const s=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),n.createElement(r.Provider,{value:s},e.children)}}}]);