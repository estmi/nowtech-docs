# 2948.1 - Programa de comandes al CRM

## Color de la linia segons si es una reserva

Afegir camp ppl.IdGestioReserva

```sql
ALTER VIEW [dbo].[VPers_PrePedido_Lineas] AS

SELECT 
    case when ppl.IdTipoOferta IS NULL then ppfo.Orden + 100 else coalesce(ppfo.Orden,9999) end AS orden, --PRIMERO LAS OFERTAS
    IdPrePedido, IdPrePedidoLinea, ppl.IdArticulo, DescripArticle, 
    COALESCE(QuantVenta, 0) AS QuantVenta, cantidad, TipoUnidad, coalesce(PrecioFeina,0)+Precio as Precio, Precio as PrecioSinFeina,
    TipoObservacion, Observacion, COALESCE(UltPrecio, 0) AS UltPrecio,
    CONVERT(VARCHAR(50), UltVenta, 103) AS UltVenta,
    COALESCE(CONVERT(VARCHAR(20), StockCalc), '') AS StockCalc, 
    PPT.Color AS COLOR, ppfo.CSSCursiva AS Cursiva,
	
	 CASE 
        WHEN ppfo.StockTachado = 1 and (ppl.StockCalc IS NULL OR ppl.StockCalc < 0.1) THEN ppfo.CSSTachado
        ELSE 'none'
    END AS Tachado , ppl.PreuCost, ppl.PrecioFeina, ppl.IdArticuloFeina, ppl.IdArticuloHijo, ppl.IdGestioReserva
FROM Pers_PrePedido_Lineas PPL
LEFT JOIN [dbo].[Pers_PrePedido_TipoPromocion] PPT 
    ON PPT.IdTipoPromocion = PPL.IdTipoOferta
LEFT JOIN vPers_Articles_Simplificado va 
    ON ppl.IdArticulo = va.IdArticulo
LEFT JOIN [dbo].[Pers_PrePedido_Familias_Orden] PPFO
	ON PPFO.Familia = VA.Familia
WHERE ppl.Visible = 1 
```

```sql
ALTER VIEW [dbo].[VPers_PrePedido_Lineas_Grid] AS
SELECT --TOP 999999999
    V.orden,
    V.IdPrePedido, 
    IdPrePedidoLinea, 
    V.IdArticulo, 
    DescripArticle, 
    QuantVenta, 
    cantidad, 
    TipoUnidad, 
    v.Precio, 
    TipoObservacion, 
    V.Observacion, 
    UltPrecio, 
    UltVenta, 
    StockCalc,v.PrecioSinFeina, v.IdArticuloFeina,v.IdArticuloHijo,

    CASE 
        WHEN COLOR IS NOT NULL THEN 
            CONCAT('background-color: ', COLOR, ' !important;') 
		when V.IdGestioReserva is not null or V.IdGestioReserva <> 0
		then 'background-color: #ffe285 !important;' 
        when cantidad<>0 then'background-color: #bfffb3 !important;' 
		else ''
    END AS Color,

    CASE 
        WHEN v.Precio IS NULL OR v.Precio = 0 THEN 
            CONCAT('background-color: #fdbdbd !important;', '') 
        WHEN COLOR IS NOT NULL THEN 
            '' 
        ELSE  
            CONCAT('background-color: #98ceff !important;', '') 
    END AS ColorPrecio,

    Cursiva, 
    Tachado ,
	CASE 
        WHEN TipoUnidad LIKE 'Far.'  THEN 
            (CASE WHEN CA.P_PecXFdo = 0 THEN 1 ELSE CA.P_PecXFdo END) * (CASE WHEN CA.P_KgsXPec = 0 THEN 1 ELSE CA.P_KgsXPec END)*cantidad
                
        WHEN TipoUnidad = 'Pec' THEN 
                        (CASE WHEN CA.P_KgsXPec = 0 THEN 1 ELSE CA.P_KgsXPec END) * cantidad              
		
	else cantidad
    END AS TotalCantidad,

	coalesce(CASE 
        WHEN TipoUnidad LIKE 'Far.'  THEN 
            (CASE WHEN CA.P_PecXFdo = 0 THEN 1 ELSE CA.P_PecXFdo END) * (CASE WHEN CA.P_KgsXPec = 0 THEN 1 ELSE CA.P_KgsXPec END)*1
                
        WHEN TipoUnidad = 'Pec' THEN 
                        (CASE WHEN CA.P_KgsXPec = 0 THEN 1 ELSE CA.P_KgsXPec END) * 1              
		
	
    END,1) AS KGPres,
	(CASE 
        WHEN TipoUnidad LIKE 'Far.'  THEN 
            (CASE WHEN CA.P_PecXFdo = 0 THEN 1 ELSE CA.P_PecXFdo END) * (CASE WHEN CA.P_KgsXPec = 0 THEN 1 ELSE CA.P_KgsXPec END)*cantidad
                
        WHEN TipoUnidad = 'Pec' THEN 
                        (CASE WHEN CA.P_KgsXPec = 0 THEN 1 ELSE CA.P_KgsXPec END) * cantidad              
		
	else cantidad
    END)*v.Precio AS TotalPrecio, a.IdTipoUnidadPres,a.TipoCantidad
, ca.P_ComandaPresKgs as PermiteKGS,  ca.P_ComandaPresPec as PermitePEC,  ca.P_ComandaPresFdo as PermiteFDO
,Coalesce((ept.PermetT1* coalesce(LL1.Precio, hLL1.Precio)),coalesce(LL1.Precio, hLL1.Precio))				 as PrecioT1
,ept.PermetT2* coalesce(nullif(LL2.Precio,0), hLL2.Precio)										 as PrecioT2
,ept.PermetT3* coalesce(LL3.Precio, hLL3.Precio)										 as PrecioT3
,ept.PermetT4* coalesce(LL4.Precio, hLL4.Precio)										 as PrecioT4
,ept.PermetT5* coalesce(LL5.Precio, hLL5.Precio)										 as PrecioT5
--,(select top 1 coste from [dbo].[fPers_Dame_Precio_Coste](v.IdArticulo,getdate(),null,null)) as oo
,v.PreuCost, v.PrecioFeina
FROM [VPers_PrePedido_Lineas] V
LEFT JOIN Pers_PrePedido PP ON v.IdPrePedido = pp.IdPrePedido
LEFT JOIN Conf_Clientes cc on pp.IdCliente = cc.IdCliente
LEFT JOIN Articulos A ON V.IdArticulo = A.IdArticulo 
LEFT JOIN Conf_Articulos CA ON V.IdArticulo = CA.IdArticulo
left join Conf_Empresas ce on ce.IdEmpresa = pp.IdEmpresa
LEFT JOIN Listas_Precios_Cli_Art LL1 ON LL1.IdLista = ce.Pers_IdListaPrecioCliT1 and V.IdArticulo = LL1.IdArticulo
LEFT JOIN Listas_Precios_Cli_Art LL2 ON LL2.IdLista = ce.Pers_IdListaPrecioCliT2 and V.IdArticulo = LL2.IdArticulo
LEFT JOIN Listas_Precios_Cli_Art LL3 ON LL3.IdLista = ce.Pers_IdListaPrecioCliT3 and V.IdArticulo = LL3.IdArticulo
LEFT JOIN Listas_Precios_Cli_Art LL4 ON LL4.IdLista = ce.Pers_IdListaPrecioCliT4 and V.IdArticulo = LL4.IdArticulo
LEFT JOIN Listas_Precios_Cli_Art LL5 ON LL5.IdLista = ce.Pers_IdListaPrecioCliT5 and V.IdArticulo = LL5.IdArticulo
LEFT JOIN Listas_Precios_Cli_Art hLL1 ON hLL1.IdLista = ce.Pers_IdListaPrecioCliT1 and V.IdArticuloHijo = hLL1.IdArticulo
LEFT JOIN Listas_Precios_Cli_Art hLL2 ON hLL2.IdLista = ce.Pers_IdListaPrecioCliT2 and V.IdArticuloHijo = hLL2.IdArticulo
LEFT JOIN Listas_Precios_Cli_Art hLL3 ON hLL3.IdLista = ce.Pers_IdListaPrecioCliT3 and V.IdArticuloHijo = hLL3.IdArticulo
LEFT JOIN Listas_Precios_Cli_Art hLL4 ON hLL4.IdLista = ce.Pers_IdListaPrecioCliT4 and V.IdArticuloHijo = hLL4.IdArticulo
LEFT JOIN Listas_Precios_Cli_Art hLL5 ON hLL5.IdLista = ce.Pers_IdListaPrecioCliT5 and V.IdArticuloHijo = hLL5.IdArticulo
LEFT JOIN [Puignau].[dbo].[ExcepcionsPermisosTipusClient] EPT ON cc.P_TipusABC = EPT.TipusClient
```

## Obtenir linia de reserva correctament segons idreserva

```sql
ALTER   PROCEDURE [dbo].[pPers_Gestio_Articles_Reserva_Precio]
(
    @NumOrigen      INT,
    @Id             INT, 
    @IdPrePedido    INT, 
    @Precio         NUMERIC(18,2)
)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @OrigenTabla VARCHAR(50);
    DECLARE @IdPrePedidoLinea INT;

    -- Obtener el nombre de la tabla de origen
    SELECT @OrigenTabla = OrigenDetall 
    FROM vPers_Gestio_Articles_Reserva_RelacioTaules 
    WHERE Num = @NumOrigen;

	

    -- Obtener el IdPrePedidoLinea correspondiente
    SELECT TOP 1 @IdPrePedidoLinea = ppl.IdPrePedidoLinea
    FROM [vPers_Gestio_Articles_Reserva_Detall_PrePedidoAvui] a
    INNER JOIN Pers_PrePedido_Lineas ppl 
        ON a.IdPrePedido = ppl.IdPrePedido 
        AND a.OrigenTabla = ppl.OrigenTaula 
        AND a.Id = ppl.IdGestioReserva
    WHERE a.IdPrePedido = @IdPrePedido
      and (a.idllotja = @Id or a.idnevera = @Id or a.idoferta = @Id) 
      AND a.OrigenTabla = @OrigenTabla;
if @Precio is null
	begin
		    SELECT TOP 1 @Precio = PreuVenda1
			FROM [vPers_Gestio_Articles_Reserva_PrePedidoAvui] a
			INNER JOIN Pers_PrePedido_Lineas ppl 
				ON a.IdPrePedido = ppl.IdPrePedido 
				AND a.Origen = ppl.OrigenTaula 
				AND a.Id = ppl.IdGestioReserva
			WHERE a.IdPrePedido = @IdPrePedido 
			  AND a.Id = ppl.IdGestioReserva 
			  AND a.Origen = @OrigenTabla;
	end
    -- Realizar el UPDATE si se ha encontrado un IdPrePedidoLinea válido
    IF @IdPrePedidoLinea IS NOT NULL
    BEGIN
        UPDATE Pers_PrePedido_Lineas
        SET Precio = @Precio
        WHERE IdPrePedido = @IdPrePedido 
          AND IdPrePedidoLinea = @IdPrePedidoLinea;
          
        select 'refreshEditGridP(); refreshButtonera();' as JSCode
    END
    ELSE
    BEGIN
        SELECT 'No se encontró la línea de pedido correspondiente.' AS Mensaje;
    END

    RETURN -1;
END;
```

## Set preu minim a nevera

Anar a l'objecte `P_GestioArticleReservaAvui` i obrir el pas 3, canviar `sql`.

```sql
select IdPrePedido,Origen,Id,Data,convert(varchar,Data,103) as Data2,Article,Nom,NomFrances,NomCastella,TipusUnitat,Unitats,PreuCost,PreuCostBotiga,PreuVenda1,PreuVenda2,PreuVenda3,PreuVenda4,PreuVenda5,PreuVenda1Minim,PreuVendaBotiga,Descte2,Descte3,Descte4,Descte5,IncT2,
PreuVendaT2,Bloquejat,PendentArribar,KgsPerFardo,KgsPerPeca,PecesPerFardo,Kgs,UnitatMesura,PreuCostTotal,ConversioKgs,TipusLiquidacio,TipusMotiu,Motiu,
CasellaCompra,Avis,AmbAlbara,Visible,UltimPreuVenda1,VeureComentarisMBCN,EsOferta,NomArticleClient,Comentaris,Grup,OrigenPreu,OrigenCarrega,Marge,Marge2,Marge3,Marge4,Marge5,
UnitatsReservades,CustomId,NumOrigen,Queden,Comanda,NomGrup, Comentaris, ColorComentaris, PreuMinimAplicable
 from vPers_Gestio_Articles_Reserva_PrePedidoAvui a
 inner join vPers_PrePedido_Combo_Articulo b on a.Article = b.IdArticulo
 order by Nom
```
